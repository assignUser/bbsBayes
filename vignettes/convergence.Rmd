---
title: "Assessing Model Convergence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Assessing Model Convergence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(bbsBayes)
```


Let's start by running a quick (and dirty) model looking at the Pacific Wren.

```{r}
m <- stratify(by = "bbs_cws", sample_data = TRUE) %>%
  prepare_data(species = "Pacific Wren", min_year = 2009, max_year = 2018) %>%
  run_model(model = "first_diff",
            iter_sampling = 20, iter_warmup = 20, chains = 2)

```

Now we can calculate our convergence metrics
```{r}
conv <- convergence(m)
conv
```

Wow, there are a *lot* of variables here.

We can visualize this by transforming the data frame and using ggplot2

```{r}
tconv <- tidyr::pivot_longer(conv, cols = c(ess_bulk, ess_tail, rhat))

ggplot2::ggplot(data = tconv, ggplot2::aes(x = variable, y = value, colour = variable_type)) +
    ggplot2::geom_point() +
    ggplot2::facet_wrap(~name, scales = "free_y") +
    ggplot2::scale_colour_viridis_d()
```

